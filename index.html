<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éù„É¢„Éâ„Éº„É≠„Çø„Ç§„Éû„Éº</title>

    <!-- PWA / „Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åô„Çã„Åü„ÇÅ„ÅÆË®≠ÂÆö -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="„Éù„É¢„Éâ„Éº„É≠">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">


    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background 1s ease-in-out;
        }
        .focus-ring-custom:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
        }
        .fade-ui {
            transition: opacity 0.5s ease-in-out;
        }
        #timer-card {
            transition: background-color 0.5s ease-in-out, box-shadow 0.5s ease-in-out, backdrop-filter 0.5s ease-in-out;
        }
        #timer-card.focus-mode {
            background-color: transparent;
            box-shadow: none;
            backdrop-filter: none;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
    </style>
</head>
<body id="app-body" class="bg-gray-900 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto p-4 md:p-6 relative">
        <!-- Goal Setting Screen -->
        <div id="goal-screen">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white">ÁõÆÊ®ô„ÇíË®≠ÂÆö</h1>
            </header>
            <div class="bg-white/10 p-8 rounded-lg shadow-lg backdrop-blur-md text-center">
                <label for="goal-input" class="block text-white font-semibold mb-2">‰Ωï„Éù„É¢„Éâ„Éº„É≠ÈõÜ‰∏≠„Åó„Åæ„Åô„ÅãÔºü</label>
                <input type="text" id="goal-input" value="4" class="w-full text-center bg-gray-700 text-white text-2xl p-3 rounded border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none" inputmode="numeric">
                <div id="total-time-display" class="text-white/70 mt-4 h-12 flex flex-col items-center justify-center">
                    <p>ÂêàË®àÊôÇÈñì: <span id="total-time-value"></span></p>
                    <p>(<span id="finish-time-value"></span> ÁµÇ‰∫Ü‰∫àÂÆö)</p>
                </div>
                <button id="start-goal-btn" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold py-4 px-8 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus-ring-custom">
                    ÈõÜ‰∏≠„ÇíÈñãÂßã„Åô„Çã
                </button>
            </div>
        </div>

        <!-- Main Timer Screen (Initially Hidden) -->
        <div id="main-timer-screen" class="hidden">
            <!-- Settings Button in top right -->
            <div id="settings-button-container" class="absolute top-4 right-4 z-10 fade-ui">
                <button id="settings-btn" class="p-3 text-white/70 hover:text-white transition-colors duration-300 focus-ring-custom rounded-full hover:bg-white/10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
            </div>

            <header id="app-header" class="text-center mb-8 fade-ui">
                <h1 class="text-3xl font-bold text-white">„Éù„É¢„Éâ„Éº„É≠„Çø„Ç§„Éû„Éº</h1>
            </header>

            <main>
                <!-- Timer Card -->
                <div id="timer-card" class="bg-white/10 p-6 rounded-lg shadow-lg backdrop-blur-md">
                    <!-- Mode Buttons -->
                    <div id="mode-buttons-container" class="flex justify-center bg-black/20 p-1.5 rounded-full mb-6 fade-ui">
                        <button id="pomodoro-btn" class="mode-button flex-1 py-2 px-4 text-sm font-bold rounded-full transition-colors duration-300 focus-ring-custom text-white" data-mode="pomodoro">„Éù„É¢„Éâ„Éº„É≠</button>
                        <button id="short-break-btn" class="mode-button flex-1 py-2 px-4 text-sm font-bold rounded-full transition-colors duration-300 focus-ring-custom text-white" data-mode="shortBreak">Áü≠„ÅÑ‰ºëÊÜ©</button>
                        <button id="long-break-btn" class="mode-button flex-1 py-2 px-4 text-sm font-bold rounded-full transition-colors duration-300 focus-ring-custom text-white" data-mode="longBreak">Èï∑„ÅÑ‰ºëÊÜ©</button>
                    </div>
                    
                    <!-- Progress Info -->
                    <div id="progress-info" class="text-center text-white/80 mb-4 h-12 flex items-center justify-center">
                        <p id="remaining-sessions"></p>
                    </div>

                    <div id="background-status" class="text-center text-white/60 mb-4 space-y-2 hidden">
                        <p id="background-status-text">„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Åß„ÅØ„Éü„Éã„Éó„É¨„Éº„É§„Éº„Å®„Åó„Å¶Ë°®Á§∫„Åï„Çå„ÄÅ„É≠„ÉÉ„ÇØÁîªÈù¢„Åß„ÇÇ„Çø„Ç§„Éû„Éº„ÅåÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇÈÄöÁü•„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                        <button id="enable-notifications-btn" class="bg-white/20 hover:bg-white/30 text-white text-sm font-semibold px-4 py-2 rounded-full focus-ring-custom">
                            ÈÄöÁü•„ÇíÊúâÂäπ„Å´„Åô„Çã
                        </button>
                    </div>

                    <!-- Timer Display with Visual Progress -->
                    <div class="relative flex items-center justify-center w-64 h-64 md:w-72 md:h-72 mx-auto my-8">
                        <svg class="absolute top-0 left-0 w-full h-full" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" class="fill-white/10" />
                            <path id="progress-path" />
                        </svg>
                        <p id="timer-display" class="relative text-7xl md:text-8xl font-extrabold text-white tracking-tighter fade-ui">25:00</p>
                        <!-- Session Notification -->
                        <div id="session-notification" class="absolute inset-0 flex items-center justify-center opacity-0 transition-opacity duration-500 pointer-events-none">
                            <div class="bg-black/50 text-white text-lg font-bold py-4 px-8 rounded-lg backdrop-blur-sm text-center">
                                <p id="session-name" class="text-2xl mb-2"></p>
                                <p id="notification-remaining-sessions" class="text-base font-normal"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Control Buttons -->
                    <div id="control-buttons-container" class="flex items-center justify-center space-x-4 fade-ui">
                        <button id="reset-btn" class="p-4 text-white/70 hover:text-white transition-colors duration-300 focus-ring-custom rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
                            </svg>
                        </button>
                        <button id="start-pause-btn" class="w-48 bg-white text-red-500 text-2xl font-bold py-4 px-8 rounded-lg shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-105 focus-ring-custom">
                            ÈñãÂßã
                        </button>
                         <button id="skip-btn" class="p-4 text-white/70 hover:text-white transition-colors duration-300 focus-ring-custom rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="counter-container" class="text-center mt-6 fade-ui">
                    <p id="pomodoro-counter" class="text-white/80 text-lg font-semibold">„Éù„É¢„Éâ„Éº„É≠ #1</p>
                </div>
            </main>
        </div>
        
        <!-- Goal Completed Screen -->
        <div id="goal-completed-screen" class="hidden">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white">„ÅäÁñ≤„ÇåÊßò„Åß„Åó„ÅüÔºÅ</h1>
            </header>
            <div class="bg-white/10 p-8 rounded-lg shadow-lg backdrop-blur-md text-center text-white">
                <p class="text-lg">ÁõÆÊ®ô„ÇíÈÅîÊàê„Åó„Åæ„Åó„Åü„ÄÇ</p>
                <div class="my-6 text-xl space-y-2">
                    <p>ÂÆüË°å„Çª„ÉÉ„Ç∑„Éß„É≥: <span id="completed-sessions"></span></p>
                    <p>ÂêàË®àÊôÇÈñì: <span id="completed-time"></span></p>
                </div>
                <button id="add-sessions-btn" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold py-4 px-8 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus-ring-custom">
                    „Çª„ÉÉ„Ç∑„Éß„É≥„ÇíËøΩÂä†„Åô„Çã
                </button>
                <button id="end-session-btn" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white text-xl font-bold py-4 px-8 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus-ring-custom">
                    ÁµÇ‰∫Ü
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 text-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6">Ë®≠ÂÆö</h2>
            <div class="space-y-4">
                <div>
                    <label for="pomodoro-duration-input" class="block mb-1 font-semibold">„Éù„É¢„Éâ„Éº„É≠ (ÂàÜ)</label>
                    <div class="flex items-center space-x-2">
                        <button class="adjust-btn p-2 rounded-md bg-gray-700 hover:bg-gray-600" data-target="pomodoro-duration-input" data-amount="-1">-</button>
                        <input type="text" id="pomodoro-duration-input" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none text-center" inputmode="numeric">
                        <button class="adjust-btn p-2 rounded-md bg-gray-700 hover:bg-gray-600" data-target="pomodoro-duration-input" data-amount="1">+</button>
                    </div>
                </div>
                <div>
                    <label for="short-break-duration-input" class="block mb-1 font-semibold">Áü≠„ÅÑ‰ºëÊÜ© (ÂàÜ)</label>
                     <div class="flex items-center space-x-2">
                        <button class="adjust-btn p-2 rounded-md bg-gray-700 hover:bg-gray-600" data-target="short-break-duration-input" data-amount="-1">-</button>
                        <input type="text" id="short-break-duration-input" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none text-center" inputmode="numeric">
                        <button class="adjust-btn p-2 rounded-md bg-gray-700 hover:bg-gray-600" data-target="short-break-duration-input" data-amount="1">+</button>
                    </div>
                </div>
                <div>
                    <label for="long-break-duration-input" class="block mb-1 font-semibold">Èï∑„ÅÑ‰ºëÊÜ© (ÂàÜ)</label>
                    <div class="flex items-center space-x-2">
                        <button class="adjust-btn p-2 rounded-md bg-gray-700 hover:bg-gray-600" data-target="long-break-duration-input" data-amount="-1">-</button>
                        <input type="text" id="long-break-duration-input" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none text-center" inputmode="numeric">
                        <button class="adjust-btn p-2 rounded-md bg-gray-700 hover:bg-gray-600" data-target="long-break-duration-input" data-amount="1">+</button>
                    </div>
                </div>
                <div class="pt-4">
                    <label for="auto-cycle-toggle" class="flex items-center justify-between cursor-pointer">
                        <span class="font-semibold">Ê¨°„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíËá™ÂãïÁöÑ„Å´ÈñãÂßã</span>
                        <span class="relative">
                            <input type="checkbox" id="auto-cycle-toggle" class="sr-only peer">
                            <span class="block w-14 h-8 bg-gray-600 rounded-full peer-checked:bg-blue-600 transition"></span>
                            <span class="absolute left-1 top-1 block w-6 h-6 bg-white rounded-full transition-transform peer-checked:translate-x-full"></span>
                        </span>
                    </label>
                </div>
            </div>
            <div class="mt-8 flex justify-end">
                <button id="save-settings-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const appBody = document.getElementById('app-body');
            const goalScreen = document.getElementById('goal-screen');
            const mainTimerScreen = document.getElementById('main-timer-screen');
            const goalCompletedScreen = document.getElementById('goal-completed-screen');
            const goalInput = document.getElementById('goal-input');
            const totalTimeValue = document.getElementById('total-time-value');
            const finishTimeValue = document.getElementById('finish-time-value');
            const startGoalBtn = document.getElementById('start-goal-btn');
            const addSessionsBtn = document.getElementById('add-sessions-btn');
            const endSessionBtn = document.getElementById('end-session-btn');
            const completedSessionsDisplay = document.getElementById('completed-sessions');
            const completedTimeDisplay = document.getElementById('completed-time');
            const timerDisplay = document.getElementById('timer-display');
            const startPauseBtn = document.getElementById('start-pause-btn');
            const resetBtn = document.getElementById('reset-btn');
            const skipBtn = document.getElementById('skip-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const modeButtons = document.querySelectorAll('.mode-button');
            const pomodoroCounterDisplay = document.getElementById('pomodoro-counter');
            const progressPath = document.getElementById('progress-path');
            const timerCard = document.getElementById('timer-card');
            const sessionNotification = document.getElementById('session-notification');
            const sessionName = document.getElementById('session-name');
            const notificationRemainingSessions = document.getElementById('notification-remaining-sessions');
            const progressInfo = document.getElementById('progress-info');
            const remainingSessionsDisplay = document.getElementById('remaining-sessions');
            const backgroundStatus = document.getElementById('background-status');
            const backgroundStatusText = document.getElementById('background-status-text');
            const enableNotificationsBtn = document.getElementById('enable-notifications-btn');
            const uiToHide = [
                document.getElementById('app-header'),
                document.getElementById('settings-button-container'),
                document.getElementById('mode-buttons-container'),
                document.getElementById('control-buttons-container'),
                document.getElementById('counter-container'),
                timerDisplay
            ];
            // Modal elements
            const settingsModal = document.getElementById('settings-modal');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const pomodoroInput = document.getElementById('pomodoro-duration-input');
            const shortBreakInput = document.getElementById('short-break-duration-input');
            const longBreakInput = document.getElementById('long-break-duration-input');
            const durationInputs = [pomodoroInput, shortBreakInput, longBreakInput];
            const adjustButtons = document.querySelectorAll('.adjust-btn');
            const autoCycleToggle = document.getElementById('auto-cycle-toggle');

            // --- Timer Settings ---
            let DURATION = {
                pomodoro: 25 * 60,
                shortBreak: 5 * 60,
                longBreak: 15 * 60,
            };

            // --- State ---
            let mode = 'pomodoro';
            let timeRemaining = DURATION.pomodoro; // in seconds
            let isActive = false;
            let logicTimerInterval = null;
            let animationFrameId = null;
            let endTime = 0; // Timestamp for when the timer ends
            let pomodoroCount = 0; // For the current goal
            let sessionCount = 1;
            let notificationTimeout = null;
            let isAutoCycle = true; // Default to automatic cycle
            let targetPomodoros = 4;
            let cumulativePomodoroCount = 0; // Total across all goals
            let cumulativeElapsedTime = 0; // Total across all goals
            let backgroundNotificationInterval = null;
            let backgroundNotification = null;
            let mediaSessionInitialized = false;

            // --- Colors ---
            const COLORS = {
                pomodoro: 'bg-gradient-to-br from-gray-900 to-red-900',
                shortBreak: 'bg-gradient-to-br from-gray-900 to-teal-900',
                longBreak: 'bg-gradient-to-br from-gray-900 to-blue-900',
            };
            const TEXT_COLORS = {
                pomodoro: 'text-red-400',
                shortBreak: 'text-teal-400',
                longBreak: 'text-blue-400',
            };
            const FILL_COLORS = {
                pomodoro: 'fill-red-950',
                shortBreak: 'fill-teal-950',
                longBreak: 'fill-blue-950',
            };
            const SESSION_NAMES = {
                pomodoro: '„Éù„É¢„Éâ„Éº„É≠',
                shortBreak: 'Áü≠„ÅÑ‰ºëÊÜ©',
                longBreak: 'Èï∑„ÅÑ‰ºëÊÜ©'
            };

            const SUPPORTS_NOTIFICATIONS = 'Notification' in window;
            const SUPPORTS_MEDIA_SESSION = 'mediaSession' in navigator && 'MediaMetadata' in window;
            const MINI_PLAYER_ARTWORK = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üçÖ</text></svg>';

            // --- Helper Functions ---
            function toHalfWidth(str) {
                if (!str) return '';
                return str.replace(/[Ôºê-Ôºô]/g, (s) => {
                    return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
                }).replace(/[^0-9]/g, '');
            }
            
            function formatTime(totalSeconds) {
                if (totalSeconds < 60) return `${Math.ceil(totalSeconds)}Áßí`;
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                let result = '';
                if (hours > 0) result += `${hours}ÊôÇÈñì `;
                if (minutes > 0) result += `${minutes}ÂàÜ`;
                return result.trim() || '0ÂàÜ';
            }

            function getFinishTime(remainingSeconds) {
                const now = new Date();
                now.setSeconds(now.getSeconds() + remainingSeconds);
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            }

            function formatClock(totalSeconds) {
                const minutes = Math.max(0, Math.floor(totalSeconds / 60));
                const seconds = Math.max(0, Math.floor(totalSeconds % 60));
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            function calculateTotalTime(pomos, startCount = 0) {
                if (pomos <= 0) return 0;
                let totalTime = pomos * DURATION.pomodoro;
                for (let i = 0; i < pomos - 1; i++) {
                    const currentPomoIndex = startCount + i + 1;
                    if (currentPomoIndex > 0 && currentPomoIndex % 4 === 0) {
                        totalTime += DURATION.longBreak;
                    } else {
                        totalTime += DURATION.shortBreak;
                    }
                }
                return totalTime;
            }

            // --- SVG Helper Functions ---
            function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
                const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
                return {
                    x: centerX + (radius * Math.cos(angleInRadians)),
                    y: centerY + (radius * Math.sin(angleInRadians))
                };
            }

            function describeArc(x, y, radius, angle) {
                if (angle <= 0) return "";
                if (angle >= 360) angle = 359.999;

                const start = polarToCartesian(x, y, radius, 0);
                const end = polarToCartesian(x, y, radius, angle);

                const largeArcFlag = angle <= 180 ? "0" : "1";
                const d = ["M", start.x, start.y, "A", radius, radius, 0, largeArcFlag, 1, end.x, end.y, "L", x, y, "Z"].join(" ");
                return d;
            }
            
            // --- Display Update Functions ---
            function updateDigitalDisplay(secs) {
                const minutes = Math.floor(secs / 60);
                const seconds = Math.floor(secs % 60);
                const newText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                if (timerDisplay.textContent !== newText) {
                    timerDisplay.textContent = newText;
                    if (window.matchMedia('(display-mode: browser)').matches) {
                        document.title = newText;
                    }
                }
            }
            
            function updateVisualDisplay(ms) {
                const totalDurationMs = DURATION[mode] * 1000;
                const progress = totalDurationMs > 0 ? ms / totalDurationMs : 0;
                const angle = 360 - (progress * 360);
                const pathData = describeArc(50, 50, 45, angle);
                progressPath.setAttribute("d", pathData);
            }
            
            function updateProgressInfo() {
                const remainingPomos = targetPomodoros - pomodoroCount;
                if (remainingPomos <= 0) {
                    progressInfo.classList.add('hidden');
                    return;
                }
                
                remainingSessionsDisplay.textContent = `ÊÆã„Çä ${remainingPomos} / ${targetPomodoros} „Éù„É¢„Éâ„Éº„É≠`;
                progressInfo.classList.remove('hidden');
            }

            // --- Animation Loop ---
            function animationLoop() {
                if (!isActive) return;
                const remainingMs = Math.max(0, endTime - performance.now());
                updateVisualDisplay(remainingMs); 
                animationFrameId = requestAnimationFrame(animationLoop);
            }
            
            // --- Notification Logic ---
            function showSessionNotification(modeName, text) {
                clearTimeout(notificationTimeout);
                sessionName.textContent = text || SESSION_NAMES[modeName];
                
                const remainingPomos = targetPomodoros - pomodoroCount;
                if (remainingPomos <= 0 || text) {
                    notificationRemainingSessions.textContent = '';
                } else {
                    notificationRemainingSessions.textContent = `ÊÆã„Çä ${remainingPomos} / ${targetPomodoros} „Éù„É¢„Éâ„Éº„É≠`;
                }
                
                sessionNotification.classList.remove('opacity-0');
                notificationTimeout = setTimeout(() => {
                    sessionNotification.classList.add('opacity-0');
                }, 15000);
            }

            function hideSessionNotification() {
                clearTimeout(notificationTimeout);
                sessionNotification.classList.add('opacity-0');
            }

            // --- Focus Mode Control ---
            const enterFocusMode = () => {
                uiToHide.forEach(el => el.classList.add('opacity-0', 'pointer-events-none'));
                timerCard.classList.add('focus-mode');
                appBody.addEventListener('click', handleBodyClick);
                progressInfo.classList.add('hidden');
                updateBackgroundStatus();
            };

            const exitFocusMode = () => {
                uiToHide.forEach(el => el.classList.remove('opacity-0', 'pointer-events-none'));
                timerCard.classList.remove('focus-mode');
                appBody.removeEventListener('click', handleBodyClick);
                updateProgressInfo();
                updateBackgroundStatus();
            };
            
            const handleBodyClick = (event) => {
                if (event.target.closest('button') || event.target.closest('#settings-modal > div')) return;
                if (isActive) pauseTimer();
            };

            // --- Timer Control Functions ---
            function startTimer() {
                if (isActive) return;
                isActive = true;
                startPauseBtn.textContent = '‰∏ÄÊôÇÂÅúÊ≠¢';
                enterFocusMode();

                endTime = performance.now() + timeRemaining * 1000;

                cancelAnimationFrame(animationFrameId);
                animationFrameId = requestAnimationFrame(animationLoop);

                startBackgroundNotifications();
                updateMediaSession(timeRemaining);

                Tone.start().catch(e => console.error("Tone.js„ÅÆÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", e));
                logicTimerInterval = setInterval(() => {
                    const remainingSeconds = Math.max(0, (endTime - performance.now()) / 1000);
                    updateDigitalDisplay(remainingSeconds);
                    timeRemaining = remainingSeconds;
                    updateBackgroundNotification(remainingSeconds);
                    updateMediaSession(remainingSeconds);

                    if (remainingSeconds <= 0) {
                        timeRemaining = 0;
                        updateDigitalDisplay(0);
                        clearInterval(logicTimerInterval);
                        cancelAnimationFrame(animationFrameId);
                        playFinishSound();
                        stopBackgroundNotifications();
                        handleTimerEnd();
                    }
                }, 250);
            }

            function pauseTimer(keepFocus = false) {
                if (!isActive) return;
                isActive = false;
                startPauseBtn.textContent = 'ÈñãÂßã';
                if (!keepFocus) {
                    exitFocusMode();
                }

                clearInterval(logicTimerInterval);
                cancelAnimationFrame(animationFrameId);
                stopBackgroundNotifications();

                timeRemaining = Math.max(0, (endTime - performance.now()) / 1000);
                updateMediaSession(timeRemaining);

                if (!keepFocus) {
                    hideSessionNotification();
                }
            }
            
            function resetTimer(keepFocus = false) {
                pauseTimer(keepFocus);
                timeRemaining = DURATION[mode];
                updateDigitalDisplay(timeRemaining);
                updateVisualDisplay(timeRemaining * 1000);
                if (!keepFocus) updateProgressInfo();
                updateMediaSession(timeRemaining);
            }

            function switchMode(newMode, keepFocus = false) {
                mode = newMode;
                resetTimer(keepFocus);
                updateUIForMode(newMode);
                startBackgroundNotifications();
                updateMediaSession(timeRemaining);
            }
            
            function handleTimerEnd() {
                if (mode === 'pomodoro') {
                    pomodoroCount++;
                }

                if (pomodoroCount >= targetPomodoros) {
                    cumulativePomodoroCount += pomodoroCount;
                    cumulativeElapsedTime += (new Date() - sessionStartTime) / 1000;
                    completedSessionsDisplay.textContent = `${cumulativePomodoroCount} „Çª„ÉÉ„Ç∑„Éß„É≥`;
                    completedTimeDisplay.textContent = formatTime(cumulativeElapsedTime);
                    stopBackgroundNotifications();
                    isActive = false;
                    updateMediaSession(0);
                    mainTimerScreen.classList.add('hidden');
                    goalCompletedScreen.classList.remove('hidden');
                    return;
                }

                const nextMode = mode === 'pomodoro' ? (pomodoroCount % 4 === 0 ? 'longBreak' : 'shortBreak') : 'pomodoro';
                if (nextMode === 'pomodoro') sessionCount++;
                
                switchMode(nextMode, isAutoCycle);
                showSessionNotification(nextMode);
                
                if (isAutoCycle) {
                    setTimeout(() => {
                        startTimer();
                    }, 1000);
                }
            }

            function updateUIForMode(currentMode) {
                appBody.className = `flex items-center justify-center min-h-screen ${COLORS[currentMode]}`;
                startPauseBtn.className = `w-48 bg-white ${TEXT_COLORS[currentMode]} text-2xl font-bold py-4 px-8 rounded-lg shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-105 focus-ring-custom`;
                progressPath.className = `${FILL_COLORS[currentMode]} opacity-60`;
                modeButtons.forEach(button => {
                    button.classList.toggle('bg-white', button.dataset.mode === currentMode);
                    button.classList.toggle('text-white', button.dataset.mode !== currentMode);
                    Object.values(TEXT_COLORS).forEach(color => button.classList.remove(color));
                    if (button.dataset.mode === currentMode) button.classList.add(TEXT_COLORS[currentMode]);
                });
                pomodoroCounterDisplay.textContent = `„Éù„É¢„Éâ„Éº„É≠ #${sessionCount}`;
            }

            function playFinishSound() {
                try {
                    const synth = new Tone.Synth().toDestination();
                    synth.triggerAttackRelease("C5", "8n", Tone.now());
                    synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.2);
                } catch (e) { console.error("„Çµ„Ç¶„É≥„Éâ„ÅÆÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", e); }
            }
            
            // --- Settings Modal Logic ---
            function openSettingsModal() {
                pomodoroInput.value = DURATION.pomodoro / 60;
                shortBreakInput.value = DURATION.shortBreak / 60;
                longBreakInput.value = DURATION.longBreak / 60;
                autoCycleToggle.checked = isAutoCycle;
                settingsModal.classList.remove('hidden');
            }

            function closeSettingsModal() {
                settingsModal.classList.add('hidden');
            }

            function saveSettings() {
                pomodoroInput.value = toHalfWidth(pomodoroInput.value);
                shortBreakInput.value = toHalfWidth(shortBreakInput.value);
                longBreakInput.value = toHalfWidth(longBreakInput.value);

                const newPomodoro = parseInt(pomodoroInput.value, 10);
                const newShortBreak = parseInt(shortBreakInput.value, 10);
                const newLongBreak = parseInt(longBreakInput.value, 10);

                if (newPomodoro > 0) DURATION.pomodoro = newPomodoro * 60;
                if (newShortBreak > 0) DURATION.shortBreak = newShortBreak * 60;
                if (newLongBreak > 0) DURATION.longBreak = newLongBreak * 60;

                isAutoCycle = autoCycleToggle.checked;

                closeSettingsModal();
                if (!isActive) {
                    resetTimer();
                }
            }

            // --- Media Session / Mini Player ---
            function updateMediaSession(remainingSeconds = timeRemaining) {
                if (!SUPPORTS_MEDIA_SESSION) return;

                const clampedRemaining = Math.max(0, remainingSeconds);
                const elapsed = Math.min(DURATION[mode], Math.max(0, DURATION[mode] - clampedRemaining));

                navigator.mediaSession.metadata = new MediaMetadata({
                    title: `${SESSION_NAMES[mode]}„Çø„Ç§„Éû„Éº`,
                    artist: isActive ? 'ÈÄ≤Ë°å‰∏≠' : '‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠',
                    album: '„Éù„É¢„Éâ„Éº„É≠„Çø„Ç§„Éû„Éº',
                    artwork: [
                        { src: MINI_PLAYER_ARTWORK, sizes: '96x96', type: 'image/svg+xml' },
                    ],
                });

                if (navigator.mediaSession.setPositionState) {
                    navigator.mediaSession.setPositionState({
                        duration: DURATION[mode],
                        position: elapsed,
                        playbackRate: 1,
                    });
                }

                navigator.mediaSession.playbackState = isActive ? 'playing' : 'paused';

                if (!mediaSessionInitialized && navigator.mediaSession.setActionHandler) {
                    navigator.mediaSession.setActionHandler('play', () => { if (!isActive) startTimer(); });
                    navigator.mediaSession.setActionHandler('pause', () => { if (isActive) pauseTimer(true); });
                    navigator.mediaSession.setActionHandler('stop', () => { pauseTimer(true); resetTimer(true); });
                    navigator.mediaSession.setActionHandler('nexttrack', () => {
                        if (isActive) pauseTimer(true);
                        handleTimerEnd();
                    });
                    mediaSessionInitialized = true;
                }
            }

            // --- Background Notification Control ---
            function updateBackgroundStatus(forceShow = false) {
                if (!SUPPORTS_NOTIFICATIONS) return;
                const permission = Notification.permission;
                const shouldShow = forceShow || permission !== 'granted';
                backgroundStatus.classList.toggle('hidden', !shouldShow);

                if (!shouldShow) return;

                if (permission === 'granted') {
                    backgroundStatusText.textContent = '„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅÆ„Éü„Éã„Éó„É¨„Éº„É§„Éº„Å®„É≠„ÉÉ„ÇØÁîªÈù¢Ë°®Á§∫„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ';
                    enableNotificationsBtn.classList.add('hidden');
                } else if (permission === 'default') {
                    backgroundStatusText.textContent = '„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Åß„ÅØ„Éü„Éã„Éó„É¨„Éº„É§„Éº„Å®„Åó„Å¶Ë°®Á§∫„Åï„Çå„ÄÅ„É≠„ÉÉ„ÇØÁîªÈù¢„Åß„ÇÇ„Çø„Ç§„Éû„Éº„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇÈÄöÁü•„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    enableNotificationsBtn.classList.remove('hidden');
                } else {
                    backgroundStatusText.textContent = 'ÈÄöÁü•„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éü„Éã„Éó„É¨„Éº„É§„ÉºË°®Á§∫„ÅÆ„Åü„ÇÅ„Å´„Éñ„É©„Ç¶„Ç∂Ë®≠ÂÆö„Åã„ÇâË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    enableNotificationsBtn.classList.add('hidden');
                }
            }

            function requestNotificationPermission() {
                if (!SUPPORTS_NOTIFICATIONS) return;
                Notification.requestPermission().then(updateBackgroundStatus);
            }

            function createProgressNotification(remainingSeconds) {
                if (!SUPPORTS_NOTIFICATIONS || Notification.permission !== 'granted') return null;
                const body = `${SESSION_NAMES[mode]} ÊÆã„Çä ${formatClock(remainingSeconds)} (ÁµÇ‰∫Ü ${getFinishTime(remainingSeconds)})`;
                try {
                    return new Notification('„Éù„É¢„Éâ„Éº„É≠ÈÄ≤Ë°å‰∏≠', {
                        body,
                        tag: 'pomodoro-progress',
                        renotify: true,
                        silent: true,
                    });
                } catch (error) {
                    console.warn('ÈÄöÁü•„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', error);
                    return null;
                }
            }

            function updateBackgroundNotification(remainingSeconds) {
                if (!SUPPORTS_NOTIFICATIONS || Notification.permission !== 'granted') return;
                if (document.visibilityState !== 'hidden') {
                    stopBackgroundNotifications();
                    return;
                }
                if (remainingSeconds <= 0) {
                    stopBackgroundNotifications();
                    return;
                }
                if (!backgroundNotification || backgroundNotification.body?.includes('00:00')) {
                    backgroundNotification = createProgressNotification(remainingSeconds);
                }
            }

            function startBackgroundNotifications() {
                if (!SUPPORTS_NOTIFICATIONS || Notification.permission !== 'granted' || !isActive || document.visibilityState !== 'hidden') return;
                stopBackgroundNotifications();
                backgroundNotification = createProgressNotification(Math.max(0, (endTime - performance.now()) / 1000));
                backgroundNotificationInterval = setInterval(() => {
                    const remainingSeconds = Math.max(0, (endTime - performance.now()) / 1000);
                    backgroundNotification = createProgressNotification(remainingSeconds);
                }, 15000);
            }

            function stopBackgroundNotifications() {
                if (backgroundNotificationInterval) {
                    clearInterval(backgroundNotificationInterval);
                    backgroundNotificationInterval = null;
                }
                if (backgroundNotification) {
                    backgroundNotification.close();
                    backgroundNotification = null;
                }
            }

            // --- Event Listeners ---
            startPauseBtn.addEventListener('click', e => { e.stopPropagation(); isActive ? pauseTimer() : startTimer(); });
            resetBtn.addEventListener('click', e => { 
                e.stopPropagation(); 
                // Reset goes back to goal screen
                pauseTimer();
                pomodoroCount = 0;
                sessionCount = 1;
                cumulativePomodoroCount = 0;
                cumulativeElapsedTime = 0;
                switchMode('pomodoro');
                mainTimerScreen.classList.add('hidden');
                goalScreen.classList.remove('hidden');
            });
            skipBtn.addEventListener('click', e => {
                e.stopPropagation();
                if (isActive) {
                    pauseTimer(true); // Keep focus mode
                }
                handleTimerEnd();
            });
            settingsBtn.addEventListener('click', e => { e.stopPropagation(); openSettingsModal(); });
            saveSettingsBtn.addEventListener('click', saveSettings);
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) closeSettingsModal();
            });
            modeButtons.forEach(button => {
                button.addEventListener('click', e => {
                    e.stopPropagation();
                    if (!isActive) {
                        switchMode(e.target.dataset.mode);
                    }
                });
            });

            durationInputs.forEach(input => {
                input.addEventListener('blur', (e) => {
                    e.target.value = toHalfWidth(e.target.value);
                });
            });
            
            adjustButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetInput = document.getElementById(e.currentTarget.dataset.target);
                    const amount = parseInt(e.currentTarget.dataset.amount, 10);
                    let currentValue = parseInt(targetInput.value, 10) || 0;
                    currentValue += amount;
                    if (currentValue < 1) {
                        currentValue = 1;
                    }
                    targetInput.value = currentValue;
                });
            });
            
            goalInput.addEventListener('input', () => {
                goalInput.value = toHalfWidth(goalInput.value);
                const pomos = parseInt(goalInput.value, 10) || 0;
                const totalTime = calculateTotalTime(pomos, cumulativePomodoroCount);
                totalTimeValue.textContent = formatTime(totalTime);
                finishTimeValue.textContent = getFinishTime(totalTime);
            });

            if (SUPPORTS_NOTIFICATIONS) {
                enableNotificationsBtn.addEventListener('click', () => {
                    requestNotificationPermission();
                });

                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden' && isActive) {
                        startBackgroundNotifications();
                    } else {
                        stopBackgroundNotifications();
                    }
                });
            }
            
            startGoalBtn.addEventListener('click', () => {
                const pomos = parseInt(goalInput.value, 10);
                if (pomos > 0) {
                    targetPomodoros = pomos;
                    pomodoroCount = 0;
                    sessionCount = 1;
                    sessionStartTime = new Date();
                    switchMode('pomodoro');
                    goalScreen.classList.add('hidden');
                    mainTimerScreen.classList.remove('hidden');
                    updateProgressInfo();
                }
            });
            
            addSessionsBtn.addEventListener('click', () => {
                goalCompletedScreen.classList.add('hidden');
                goalScreen.classList.remove('hidden');
                goalInput.dispatchEvent(new Event('input')); // Recalculate time based on cumulative count
            });
            
            endSessionBtn.addEventListener('click', () => {
                window.close();
            });

            // --- Initial Setup ---
            goalInput.dispatchEvent(new Event('input')); // Calculate initial total time
            updateBackgroundStatus();
            updateMediaSession(timeRemaining);
        });
    </script>
</body>
</html>
